<div class="digital-office">
  <div class="digital-office__header">
    <div class="digital-office__header-content">
      <app-icon name="monitor" [size]="32" />
      <div>
        <h1 class="digital-office__title">Consultório Digital</h1>
        <p class="digital-office__subtitle">Gerencie as consultas dos pacientes</p>
      </div>
    </div>
  </div>

  <div class="digital-office__filters">
    <div class="digital-office__filter-tabs">
      <button 
        type="button" 
        class="digital-office__filter-tab" 
        [class.digital-office__filter-tab--active]="filterMode === 'today'"
        (click)="setFilterMode('today')"
      >
        <app-icon name="calendar" [size]="16" />
        Consultas de Hoje
      </button>
      <button 
        type="button" 
        class="digital-office__filter-tab" 
        [class.digital-office__filter-tab--active]="filterMode === 'all'"
        (click)="setFilterMode('all')"
      >
        <app-icon name="file" [size]="16" />
        Todas as Consultas
      </button>
      <button 
        type="button" 
        class="digital-office__filter-tab" 
        [class.digital-office__filter-tab--active]="filterMode === 'period'"
        (click)="setFilterMode('period')"
      >
        <app-icon name="clock" [size]="16" />
        Buscar por Período
      </button>
      <button 
        type="button" 
        class="digital-office__filter-tab" 
        [class.digital-office__filter-tab--active]="filterMode === 'cpf'"
        (click)="setFilterMode('cpf')"
      >
        <app-icon name="search" [size]="16" />
        Buscar por CPF
      </button>
    </div>

    <div class="digital-office__filter-controls">
      @if (filterMode === 'period') {
        <div class="digital-office__date-range">
          <div class="digital-office__date-group">
            <label for="startDate">Data Inicial</label>
            <input 
              type="date" 
              id="startDate"
              [(ngModel)]="startDate" 
              (change)="onDateFilterChange()"
              class="digital-office__date-input"
            />
          </div>
          <div class="digital-office__date-group">
            <label for="endDate">Data Final</label>
            <input 
              type="date" 
              id="endDate"
              [(ngModel)]="endDate" 
              (change)="onDateFilterChange()"
              class="digital-office__date-input"
            />
          </div>
        </div>
      }
      
      @if (filterMode === 'cpf') {
        <div class="digital-office__cpf-search">
          <div class="digital-office__cpf-group">
            <label for="searchCpf">CPF do Paciente</label>
            <div class="digital-office__cpf-wrapper">
              <input 
                type="text" 
                id="searchCpf"
                [(ngModel)]="searchCpf" 
                appCpfMask
                placeholder="000.000.000-00"
                class="digital-office__cpf-input"
                (keyup.enter)="onSearchCpf()"
              />
              <button type="button" class="digital-office__search-btn" (click)="onSearchCpf()">
                <app-icon name="search" [size]="18" />
              </button>
            </div>
          </div>
        </div>
      }
      
      <div class="digital-office__advanced-filters">
        <app-filter-select
          [options]="specialtyOptions"
          [(ngModel)]="specialtyFilter"
          (change)="onSpecialtyFilterChange()"
          placeholder="Filtrar por especialidade"
        />
        
        <app-filter-select
          [options]="statusOptions"
          [(ngModel)]="statusFilter"
          (change)="onStatusFilterChange()"
          placeholder="Filtrar por status"
        />
        
        @if (filterMode !== 'cpf') {
          <div class="digital-office__search-professional">
            <app-search-input 
              placeholder="Buscar por profissional..."
              [(ngModel)]="searchProfessional"
              (search)="onSearchProfessional($event)">
            </app-search-input>
          </div>
        }
      </div>
    </div>
  </div>

  @if (loading) {
    <div class="digital-office__loading">
      <p>Carregando consultas...</p>
    </div>
  } @else if (appointments.length === 0) {
    <div class="digital-office__empty">
      <app-icon name="calendar" [size]="48" />
      <p>
        @switch (filterMode) {
          @case ('today') {
            Não há consultas agendadas para hoje.
          }
          @case ('cpf') {
            Nenhuma consulta encontrada para o CPF informado.
          }
          @case ('period') {
            Nenhuma consulta encontrada no período selecionado.
          }
          @default {
            Não há consultas registradas.
          }
        }
      </p>
    </div>
  } @else {
    <!-- Desktop: Table View -->
    <div class="digital-office__desktop-view">
      <div class="digital-office__table-wrapper">
        <table class="digital-office-table">
          <thead class="digital-office-table__head">
            <tr>
              <th class="digital-office-table__header">DATA/HORA</th>
              <th class="digital-office-table__header">PACIENTE</th>
              <th class="digital-office-table__header">PROFISSIONAL</th>
              <th class="digital-office-table__header">ESPECIALIDADE</th>
              <th class="digital-office-table__header">TIPO</th>
              <th class="digital-office-table__header">STATUS</th>
              <th class="digital-office-table__header digital-office-table__header--actions">AÇÕES</th>
            </tr>
          </thead>
          <tbody class="digital-office-table__body">
            @for (appt of appointments; track appt.id) {
              <tr class="digital-office-table__row">
                <td class="digital-office-table__cell">
                  <div class="digital-office-table__datetime">
                    <span class="digital-office-table__date">{{ appt.date | date:'dd/MM/yyyy' }}</span>
                    <span class="digital-office-table__time">{{ formatTime(appt.time) }}</span>
                  </div>
                </td>
                <td class="digital-office-table__cell">
                  <div class="digital-office-table__patient">
                    <span class="digital-office-table__patient-name">{{ appt.patientName }}</span>
                  </div>
                </td>
                <td class="digital-office-table__cell">
                  <span>{{ appt.professionalName }}</span>
                </td>
                <td class="digital-office-table__cell">
                  <span>{{ appt.specialtyName }}</span>
                </td>
                <td class="digital-office-table__cell">
                  <span>{{ getTypeLabel(appt.type) }}</span>
                </td>
                <td class="digital-office-table__cell">
                  <app-badge 
                    [variant]="getStatusBadgeVariant(appt.status)" 
                    [label]="getStatusLabel(appt.status)" 
                    size="sm" 
                  />
                </td>
                <td class="digital-office-table__cell digital-office-table__cell--actions">
                  <div class="digital-office-table__actions">
                    @if (canEnterConsultation(appt)) {
                      <button
                        type="button"
                        class="digital-office-table__action-btn-primary"
                        (click)="enterConsultation(appt)"
                        title="Entrar na consulta"
                      >
                        <app-icon name="video" [size]="16" />
                        <span>Entrar</span>
                      </button>
                    }
                    <button
                      type="button"
                      class="digital-office-table__action-btn"
                      (click)="openDetails(appt)"
                      title="Ver detalhes"
                    >
                      <app-icon name="eye" [size]="18" />
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile/Tablet: Card View -->
    <div class="digital-office__mobile-view">
      @for (appt of appointments; track appt.id) {
        <div class="appointment-card">
          <div class="appointment-card__header">
            <div class="appointment-card__datetime">
              <span class="appointment-card__date">{{ appt.date | date:'dd/MM/yyyy' }}</span>
              <span class="appointment-card__time">{{ formatTime(appt.time) }}</span>
            </div>
            <app-badge 
              [variant]="getStatusBadgeVariant(appt.status)" 
              [label]="getStatusLabel(appt.status)" 
              size="sm" 
            />
          </div>

          <div class="appointment-card__content">
            <div class="appointment-card__info">
              <div class="appointment-card__info-group">
                <span class="appointment-card__label">Paciente</span>
                <span class="appointment-card__value">{{ appt.patientName }}</span>
              </div>
              <div class="appointment-card__info-group">
                <span class="appointment-card__label">Profissional</span>
                <span class="appointment-card__value">{{ appt.professionalName }}</span>
              </div>
              <div class="appointment-card__info-group">
                <span class="appointment-card__label">Especialidade</span>
                <span class="appointment-card__value">{{ appt.specialtyName }}</span>
              </div>
              <div class="appointment-card__info-group">
                <span class="appointment-card__label">Tipo</span>
                <span class="appointment-card__value">{{ getTypeLabel(appt.type) }}</span>
              </div>
            </div>
          </div>

          <div class="appointment-card__actions">
            @if (canEnterConsultation(appt)) {
              <button
                type="button"
                class="appointment-card__btn-primary"
                (click)="enterConsultation(appt)"
              >
                <app-icon name="video" [size]="18" />
                <span>Entrar na Consulta</span>
              </button>
            }
            <button
              type="button"
              class="appointment-card__btn-secondary"
              (click)="openDetails(appt)"
            >
              <app-icon name="eye" [size]="16" />
              <span>Detalhes</span>
            </button>
          </div>
        </div>
      }
    </div>

    <app-pagination
      [currentPage]="currentPage"
      [totalPages]="totalPages"
      [pageSize]="pageSize"
      [total]="totalAppointments"
      (pageChange)="onPageChange($event)"
    />
  }
</div>

<!-- Modal de Detalhes -->
@if (isDetailsModalOpen && selectedAppointment) {
  <app-appointment-details-modal
    [isOpen]="isDetailsModalOpen"
    [appointment]="selectedAppointment"
    (close)="closeDetailsModal()"
  />
}
