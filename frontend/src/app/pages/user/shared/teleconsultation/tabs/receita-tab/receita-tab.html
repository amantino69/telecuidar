<div class="receita-container">
  <!-- Toast de Sucesso -->
  @if (showSuccessToast) {
    <div class="success-toast" (click)="hideToast()">
      <app-icon name="check-circle" [size]="18" />
      <span>{{ successToastMessage }}</span>
      <button class="toast-close" (click)="hideToast()">
        <app-icon name="close" [size]="14" />
      </button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando receitas...</p>
    </div>
  } @else {
    <!-- Header -->
    <div class="receita-header">
      <div class="header-content">
        <h3>
          <app-icon name="file" [size]="20" />
          Receituário Médico
        </h3>
      </div>
      
      @if (canEdit && !showItemForm) {
        <div class="header-actions">
          <app-button 
            variant="primary" 
            size="sm"
            (click)="startNewPrescription()"
            [disabled]="isSaving">
            <app-icon name="plus" [size]="16" />
            {{ isSaving ? 'Criando...' : 'Nova Receita' }}
          </app-button>
        </div>
      }
    </div>

    <!-- Formulário de Adicionar Item (Padrão e-SUS) -->
    @if (showItemForm) {
      <div class="item-form">
        <h4>{{ isEditMode ? 'Editar Medicamento' : 'Adicionar Medicamento' }}</h4>
        
        <form [formGroup]="itemForm" (ngSubmit)="addItem()">
          <!-- Campo Medicamento com Autocomplete -->
          <div class="form-row">
            <div class="form-group">
              <label for="medicamento">Medicamento *</label>
              <div class="autocomplete-container">
                <input 
                  type="text" 
                  id="medicamento"
                  [value]="medicamentoSearch"
                  (input)="onMedicamentoInput($event)"
                  (blur)="hideDropdown()"
                  placeholder="Digite o nome do medicamento..."
                  autocomplete="off"
                />
                @if (isSearching) {
                  <div class="search-spinner"></div>
                }
                
                @if (showMedicamentoDropdown) {
                  <div class="autocomplete-dropdown">
                    @for (med of medicamentoResults; track med.codigo) {
                      <div class="dropdown-item" (mousedown)="selectMedicamento(med)">
                        <div class="med-name">{{ med.nome }}</div>
                        <div class="med-info">
                          <span class="principle">{{ med.principioAtivo }}</span>
                          @if (med.concentracao) {
                            <span class="concentration">{{ med.concentracao }}</span>
                          }
                          <span class="lab">{{ med.empresa }}</span>
                        </div>
                      </div>
                    }
                    <div class="dropdown-item free-text" (mousedown)="useFreeText()">
                      <app-icon name="edit" [size]="14" />
                      Usar "{{ medicamentoSearch }}" como texto livre
                    </div>
                  </div>
                }
              </div>
              <small class="hint">Busca na base oficial ANVISA (~14.000 medicamentos)</small>
            </div>
          </div>

          <!-- Informações do Medicamento (preenchidas automaticamente) -->
          <div class="form-row three-cols">
            <div class="form-group">
              <label for="principioAtivo">Princípio Ativo</label>
              <input 
                type="text" 
                id="principioAtivo" 
                formControlName="principioAtivo"
                placeholder="Substância ativa"
                readonly
              />
            </div>
            <div class="form-group">
              <label for="concentracao">Concentração</label>
              <input 
                type="text" 
                id="concentracao" 
                formControlName="concentracao"
                placeholder="Ex: 500mg, 20mg/ml..."
              />
            </div>
            <div class="form-group">
              <label for="formaFarmaceutica">Forma Farmacêutica</label>
              <select id="formaFarmaceutica" formControlName="formaFarmaceutica">
                <option value="">Selecione...</option>
                @for (forma of formasFarmaceuticas; track forma) {
                  <option [value]="forma">{{ forma }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Posologia Principal -->
          <div class="form-row two-cols">
            <div class="form-group">
              <label for="dosagem">Dosagem *</label>
              <input 
                type="text" 
                id="dosagem" 
                formControlName="dosagem"
                placeholder="Ex: 1 comprimido, 10ml, 2 cápsulas..."
              />
            </div>
            <div class="form-group">
              <label for="viaAdministracao">Via de Administração</label>
              <select id="viaAdministracao" formControlName="viaAdministracao">
                @for (via of viasAdministracao; track via) {
                  <option [value]="via">{{ via }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-row two-cols">
            <div class="form-group">
              <label for="frequencia">Frequência *</label>
              <input 
                type="text" 
                id="frequencia" 
                formControlName="frequencia"
                placeholder="Ex: 8/8h, 12/12h, 1x ao dia..."
              />
            </div>
            <div class="form-group">
              <label for="periodo">Período *</label>
              <input 
                type="text" 
                id="periodo" 
                formControlName="periodo"
                placeholder="Ex: 7 dias, 14 dias, uso contínuo..."
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="posologia">Posologia Completa *</label>
              <input 
                type="text" 
                id="posologia" 
                formControlName="posologia"
                placeholder="Ex: Tomar 1 comprimido por via oral após as refeições..."
              />
            </div>
          </div>

          <!-- Quantidade e Tipo de Receita -->
          <div class="form-row three-cols">
            <div class="form-group">
              <label for="quantidadeTotal">Quantidade Total</label>
              <input 
                type="number" 
                id="quantidadeTotal" 
                formControlName="quantidadeTotal"
                placeholder="Ex: 30"
                min="1"
              />
            </div>
            <div class="form-group">
              <label for="unidadeQuantidade">Unidade</label>
              <select id="unidadeQuantidade" formControlName="unidadeQuantidade">
                @for (unidade of unidadesQuantidade; track unidade) {
                  <option [value]="unidade">{{ unidade }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="tipoReceita">Tipo de Receita</label>
              <select id="tipoReceita" formControlName="tipoReceita">
                @for (tipo of tiposReceita; track tipo) {
                  <option [value]="tipo">{{ tipo }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Checkbox de medicamento controlado -->
          <div class="form-row">
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="isControlado" />
                <span>Medicamento Controlado (exige receita especial)</span>
              </label>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="observacoes">Observações (opcional)</label>
              <textarea 
                id="observacoes" 
                formControlName="observacoes"
                rows="2"
                placeholder="Observações adicionais sobre este medicamento..."
              ></textarea>
            </div>
          </div>

          <div class="form-actions">
            <app-button 
              variant="secondary" 
              type="button"
              (click)="cancelItemForm()">
              Cancelar
            </app-button>
            <app-button 
              variant="primary" 
              type="submit"
              [disabled]="itemForm.invalid || isSaving">
              @if (isSaving) {
                {{ isEditMode ? 'Salvando...' : 'Adicionando...' }}
              } @else {
                {{ isEditMode ? 'Salvar Alterações' : 'Adicionar Medicamento' }}
              }
            </app-button>
          </div>
        </form>
      </div>
    }

    <!-- Lista de Receitas -->
    @if (!showItemForm) {
      <div class="prescriptions-list">
        @if (prescriptions.length === 0) {
          <div class="empty-state">
            <app-icon name="file" [size]="48" />
            <h4>Nenhuma receita emitida</h4>
            <p>Clique em "Nova Receita" para criar uma receita médica para esta consulta.</p>
          </div>
        } @else {
          @for (prescription of prescriptions; track prescription.id; let i = $index) {
            <div class="prescription-card" [class.signed]="prescription.isSigned">
              <div class="prescription-header">
                <div class="prescription-title">
                  <app-icon name="file" [size]="18" />
                  <span>Receita #{{ i + 1 }}</span>
                  <span class="items-count">({{ prescription.items.length }} medicamento(s))</span>
                </div>
                @if (prescription.isSigned) {
                  <span class="signed-badge">
                    <app-icon name="check-circle" [size]="14" />
                    Assinado
                  </span>
                }
              </div>
              
              <div class="prescription-content">
                <!-- Lista de medicamentos -->
                @if (prescription.items.length === 0) {
                  <div class="no-items">
                    <p>Nenhum medicamento adicionado.</p>
                    @if (canEdit && !prescription.isSigned) {
                      <app-button 
                        variant="secondary" 
                        size="sm"
                        (click)="openAddItemForm(prescription.id)">
                        <app-icon name="plus" [size]="14" />
                        Adicionar Medicamento
                      </app-button>
                    }
                  </div>
                } @else {
                  <div class="medications-list">
                    @for (item of prescription.items; track item.id; let j = $index) {
                      <div class="medication-item" [class.controlado]="item.isControlado">
                        <div class="medication-header">
                          <span class="medication-number">{{ j + 1 }}</span>
                          <div class="medication-name">
                            <strong>{{ item.medicamento }}</strong>
                            @if (item.concentracao) {
                              <span class="concentration-badge">{{ item.concentracao }}</span>
                            }
                            @if (item.isControlado) {
                              <span class="controlled-badge">
                                <app-icon name="alert-circle" [size]="12" />
                                Controlado
                              </span>
                            }
                          </div>
                          @if (canEdit && !prescription.isSigned) {
                            <div class="item-actions">
                              <button class="edit-item-btn" (click)="openEditItemForm(prescription, item)" title="Editar">
                                <app-icon name="edit" [size]="14" />
                              </button>
                              <button class="remove-item-btn" (click)="removeItem(prescription.id, item.id)" title="Remover">
                                <app-icon name="trash" [size]="14" />
                              </button>
                            </div>
                          }
                        </div>
                        @if (item.principioAtivo) {
                          <div class="medication-principle">
                            <strong>Princípio Ativo:</strong> {{ item.principioAtivo }}
                          </div>
                        }
                        <div class="medication-details">
                          <span><strong>Dosagem:</strong> {{ item.dosagem }}</span>
                          @if (item.viaAdministracao) {
                            <span><strong>Via:</strong> {{ item.viaAdministracao }}</span>
                          }
                          <span><strong>Frequência:</strong> {{ item.frequencia }}</span>
                          <span><strong>Período:</strong> {{ item.periodo }}</span>
                        </div>
                        @if (item.quantidadeTotal) {
                          <div class="medication-quantity">
                            <strong>Quantidade:</strong> {{ item.quantidadeTotal }} {{ item.unidadeQuantidade || 'unidade(s)' }}
                          </div>
                        }
                        <div class="medication-posologia">
                          <strong>Posologia:</strong> {{ item.posologia }}
                        </div>
                        @if (item.observacoes) {
                          <div class="medication-obs">
                            <strong>Obs:</strong> {{ item.observacoes }}
                          </div>
                        }
                        <div class="medication-codes">
                          @if (item.codigoAnvisa) {
                            <span class="code-badge">ANVISA: {{ item.codigoAnvisa }}</span>
                          }
                          @if (item.codigoCatmat) {
                            <span class="code-badge">CATMAT: {{ item.codigoCatmat }}</span>
                          }
                          @if (item.tipoReceita && item.tipoReceita !== 'Simples') {
                            <span class="type-badge">{{ item.tipoReceita }}</span>
                          }
                        </div>
                      </div>
                    }
                  </div>
                  
                  @if (canEdit && !prescription.isSigned) {
                    <button class="add-more-btn" (click)="openAddItemForm(prescription.id)">
                      <app-icon name="plus" [size]="16" />
                      Adicionar mais medicamentos
                    </button>
                  }
                }

                <!-- Info de assinatura digital -->
                @if (prescription.isSigned) {
                  <div class="signature-info">
                    <app-icon name="shield" [size]="18" />
                    <div class="signature-details">
                      <strong>Documento Assinado Digitalmente</strong>
                      @if (prescription.certificateSubject) {
                        <p>Certificado: {{ prescription.certificateSubject }}</p>
                      }
                      @if (prescription.signedAt) {
                        <p>Data: {{ formatDate(prescription.signedAt) }}</p>
                      }
                      @if (prescription.documentHash) {
                        <p class="hash">Hash: {{ prescription.documentHash }}</p>
                      }
                    </div>
                  </div>
                }
              </div>
              
              <div class="prescription-footer">
                <span class="prescription-date">
                  <app-icon name="calendar" [size]="14" />
                  {{ formatDate(prescription.createdAt) }}
                </span>
                
                <div class="prescription-actions">
                  <!-- Ações do profissional -->
                  @if (isProfessional) {
                    @if (!prescription.isSigned && canEdit) {
                      <button class="action-btn delete" (click)="deletePrescription(prescription)" title="Excluir">
                        <app-icon name="trash" [size]="16" />
                      </button>
                      @if (hasItems(prescription)) {
                        <button 
                          class="action-btn sign" 
                          (click)="openSignModal(prescription)"
                          title="Assinar Digitalmente">
                          <app-icon name="shield" [size]="16" />
                        </button>
                      }
                    }
                    @if (hasItems(prescription) && !prescription.isSigned && canEdit) {
                      <button 
                        class="action-btn pdf" 
                        (click)="generatePdf(prescription)" 
                        [disabled]="isGeneratingPdf"
                        title="Gerar PDF Prévia">
                        <app-icon name="download" [size]="16" />
                      </button>
                    }
                  }
                  
                  <!-- Botão de download do PDF assinado - disponível para todos -->
                  @if (prescription.isSigned && hasItems(prescription)) {
                    <button 
                      class="action-btn pdf signed" 
                      (click)="downloadSignedPdf(prescription)" 
                      title="Baixar Receita Assinada (PDF)">
                      <app-icon name="download" [size]="16" />
                      <span class="btn-label">Baixar PDF</span>
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        }
      </div>
    }
  }
</div>

<!-- Modal de Assinatura Digital -->
<app-sign-document-modal
  [isOpen]="showSignModal"
  [documentType]="'prescription'"
  [documentId]="signingPrescriptionId || ''"
  (close)="closeSignModal()"
  (signed)="onDocumentSigned($event)"
/>