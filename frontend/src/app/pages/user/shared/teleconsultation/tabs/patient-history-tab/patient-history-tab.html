<div class="patient-history-tab">
  <!-- Header -->
  <div class="tab-header">
    <div class="header-info">
      <h3>
        <app-icon name="book" [size]="20"></app-icon>
        Histórico Clínico
      </h3>
      @if (timeline) {
        <span class="patient-info">
          {{ timeline.patientName }} - CPF: {{ timeline.patientCpf }}
        </span>
      }
    </div>
    <div class="header-actions">
      <button class="btn btn-sm btn-outline-primary" (click)="loadTimeline()" [disabled]="loading">
        <app-icon name="refresh-cw" [size]="14"></app-icon>
        Atualizar
      </button>
      @if (timeline && timeline.entries.length > 1) {
        <button class="btn btn-sm" [class.btn-primary]="compareMode" [class.btn-outline-secondary]="!compareMode" (click)="toggleCompareMode()">
          <app-icon name="bar-chart" [size]="14"></app-icon>
          Comparar
        </button>
      }
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando histórico clínico...</p>
    </div>
  }

  <!-- Error -->
  @if (error) {
    <div class="error-state">
      <app-icon name="alert-circle" [size]="48"></app-icon>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadTimeline()">Tentar novamente</button>
    </div>
  }

  <!-- Timeline Content -->
  @if (!loading && !error && timeline) {
    <!-- Summary Card -->
    <div class="summary-card">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="value">{{ timeline.summary.totalAppointments }}</span>
          <span class="label">Consultas</span>
        </div>
        <div class="summary-item">
          <span class="value">{{ timeline.summary.totalPrescriptions }}</span>
          <span class="label">Receitas</span>
        </div>
        <div class="summary-item">
          <span class="value">{{ timeline.summary.totalExamRequests }}</span>
          <span class="label">Exames</span>
        </div>
        <div class="summary-item">
          <span class="value">{{ timeline.summary.totalMedicalCertificates }}</span>
          <span class="label">Atestados</span>
        </div>
      </div>
      @if (timeline.summary.firstAppointmentDate) {
        <div class="summary-dates">
          <span>Primeira consulta: {{ formatDate(timeline.summary.firstAppointmentDate) }}</span>
          <span>Última consulta: {{ formatDate(timeline.summary.lastAppointmentDate!) }}</span>
        </div>
      }
    </div>

    <!-- Compare Mode View -->
    @if (compareMode && selectedForCompare.length === 2) {
      <div class="compare-container">
        <h4>Comparação de Consultas</h4>
        <div class="compare-grid">
          @for (entry of selectedForCompare; track entry.appointmentId) {
            <div class="compare-card">
              <div class="compare-header">
                <strong>{{ formatDate(entry.date) }}</strong>
                <span>{{ entry.specialtyName }}</span>
              </div>
              <div class="compare-biometrics">
                <div class="metric">
                  <span class="label">Pressão:</span>
                  <span class="value">{{ formatBloodPressure(entry.biometrics) }}</span>
                </div>
                @if (entry.biometrics?.heartRate) {
                  <div class="metric">
                    <span class="label">FC:</span>
                    <span class="value">{{ entry.biometrics!.heartRate }} bpm</span>
                  </div>
                }
                @if (entry.biometrics?.weight) {
                  <div class="metric">
                    <span class="label">Peso:</span>
                    <span class="value">{{ entry.biometrics!.weight }} kg</span>
                  </div>
                }
                @if (entry.biometrics?.temperature) {
                  <div class="metric">
                    <span class="label">Temp:</span>
                    <span class="value">{{ entry.biometrics!.temperature }}°C</span>
                  </div>
                }
                @if (entry.biometrics?.oxygenSaturation) {
                  <div class="metric">
                    <span class="label">SpO2:</span>
                    <span class="value">{{ entry.biometrics!.oxygenSaturation }}%</span>
                  </div>
                }
              </div>
              @if (entry.soap) {
                <div class="compare-soap">
                  @if (entry.soap.assessment) {
                    <div class="soap-item">
                      <strong>Avaliação:</strong>
                      <p>{{ entry.soap.assessment }}</p>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
        <button class="btn btn-outline-secondary btn-sm" (click)="selectedForCompare = []">
          Limpar seleção
        </button>
      </div>
    }

    <!-- Compare Mode Instructions -->
    @if (compareMode && selectedForCompare.length < 2) {
      <div class="compare-instructions">
        <app-icon name="info" [size]="16"></app-icon>
        Selecione {{ 2 - selectedForCompare.length }} consulta(s) para comparar
      </div>
    }

    <!-- Timeline List -->
    <div class="timeline-list">
      @for (entry of timeline.entries; track entry.appointmentId) {
        <div class="timeline-entry" 
             [class.current]="isCurrentAppointment(entry)"
             [class.selected]="isSelectedForCompare(entry)"
             [class.expanded]="selectedEntry?.appointmentId === entry.appointmentId">
          
          <!-- Entry Header -->
          <div class="entry-header" (click)="compareMode ? toggleCompareSelection(entry) : loadEntryDetails(entry)">
            @if (compareMode) {
              <div class="compare-checkbox">
                <input type="checkbox" [checked]="isSelectedForCompare(entry)" [disabled]="!isSelectedForCompare(entry) && selectedForCompare.length >= 2">
              </div>
            }
            
            <div class="entry-date">
              <span class="day">{{ formatDate(entry.date) }}</span>
              <span class="time">{{ entry.time }}</span>
            </div>
            
            <div class="entry-info">
              <div class="specialty">
                <app-icon [name]="getStatusIcon(entry.status)" [size]="14"></app-icon>
                {{ entry.specialtyName }}
                @if (isCurrentAppointment(entry)) {
                  <span class="badge badge-primary">Atual</span>
                }
              </div>
              <div class="professional">
                {{ entry.professionalName }}
                @if (entry.councilAcronym) {
                  <span class="council">{{ entry.councilAcronym }} {{ entry.councilRegistration }}/{{ entry.councilState }}</span>
                }
              </div>
            </div>
            
            <div class="entry-counts">
              @if (entry.prescriptionsCount > 0) {
                <span class="count" title="Receitas">
                  <app-icon name="file" [size]="12"></app-icon>
                  {{ entry.prescriptionsCount }}
                </span>
              }
              @if (entry.examRequestsCount > 0) {
                <span class="count" title="Exames">
                  <app-icon name="search" [size]="12"></app-icon>
                  {{ entry.examRequestsCount }}
                </span>
              }
              @if (entry.medicalCertificatesCount > 0) {
                <span class="count" title="Atestados">
                  <app-icon name="file-text" [size]="12"></app-icon>
                  {{ entry.medicalCertificatesCount }}
                </span>
              }
            </div>
            
            <div class="entry-biometrics">
              @if (entry.biometrics?.bloodPressureSystolic) {
                <span class="bp" [class]="getPressureClass(entry.biometrics, timeline.entries[timeline.entries.indexOf(entry) + 1]?.biometrics)">
                  {{ formatBloodPressure(entry.biometrics) }}
                </span>
              }
            </div>
            
            @if (!compareMode) {
              <div class="entry-expand">
                <app-icon [name]="selectedEntry?.appointmentId === entry.appointmentId ? 'chevron-up' : 'chevron-down'" [size]="16"></app-icon>
              </div>
            }
          </div>
          
          <!-- Entry Details (expanded) -->
          @if (selectedEntry?.appointmentId === entry.appointmentId && !compareMode && selectedEntry) {
            <div class="entry-details">
              @if (loadingDetails) {
                <div class="loading-details">
                  <div class="spinner-sm"></div>
                  Carregando detalhes...
                </div>
              } @else {
                <!-- AI Summary -->
                @if (selectedEntry.aiSummary) {
                  <div class="detail-section">
                    <h5><app-icon name="activity" [size]="14"></app-icon> Resumo IA</h5>
                    <p class="ai-summary">{{ selectedEntry.aiSummary }}</p>
                  </div>
                }
                
                <!-- SOAP -->
                @if (selectedEntry.soap) {
                  <div class="detail-section">
                    <h5><app-icon name="edit" [size]="14"></app-icon> Anamnese</h5>
                    <div class="soap-grid">
                      @if (selectedEntry.soap.subjective) {
                        <div class="soap-item">
                          <strong>S - Subjetivo:</strong>
                          <p>{{ selectedEntry.soap.subjective }}</p>
                        </div>
                      }
                      @if (selectedEntry.soap.objective) {
                        <div class="soap-item">
                          <strong>O - Objetivo:</strong>
                          <p>{{ selectedEntry.soap.objective }}</p>
                        </div>
                      }
                      @if (selectedEntry.soap.assessment) {
                        <div class="soap-item">
                          <strong>A - Avaliação:</strong>
                          <p>{{ selectedEntry.soap.assessment }}</p>
                        </div>
                      }
                      @if (selectedEntry.soap.plan) {
                        <div class="soap-item">
                          <strong>P - Plano:</strong>
                          <p>{{ selectedEntry.soap.plan }}</p>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Biometrics -->
                @if (selectedEntry.biometrics) {
                  <div class="detail-section">
                    <h5><app-icon name="heart" [size]="14"></app-icon> Sinais Vitais</h5>
                    <div class="biometrics-grid">
                      @if (selectedEntry.biometrics.bloodPressureSystolic) {
                        <div class="bio-item">
                          <span class="label">Pressão Arterial</span>
                          <span class="value">{{ formatBloodPressure(selectedEntry.biometrics) }}</span>
                        </div>
                      }
                      @if (selectedEntry.biometrics.heartRate) {
                        <div class="bio-item">
                          <span class="label">Freq. Cardíaca</span>
                          <span class="value">{{ selectedEntry.biometrics.heartRate }} bpm</span>
                        </div>
                      }
                      @if (selectedEntry.biometrics.temperature) {
                        <div class="bio-item">
                          <span class="label">Temperatura</span>
                          <span class="value">{{ selectedEntry.biometrics.temperature }}°C</span>
                        </div>
                      }
                      @if (selectedEntry.biometrics.oxygenSaturation) {
                        <div class="bio-item">
                          <span class="label">SpO2</span>
                          <span class="value">{{ selectedEntry.biometrics.oxygenSaturation }}%</span>
                        </div>
                      }
                      @if (selectedEntry.biometrics.weight) {
                        <div class="bio-item">
                          <span class="label">Peso</span>
                          <span class="value">{{ selectedEntry.biometrics.weight }} kg</span>
                        </div>
                      }
                      @if (selectedEntry.biometrics.glycemicIndex) {
                        <div class="bio-item">
                          <span class="label">Glicemia</span>
                          <span class="value">{{ selectedEntry.biometrics.glycemicIndex }} mg/dL</span>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Prescriptions -->
                @if (selectedEntry.prescriptions && selectedEntry.prescriptions.length > 0) {
                  <div class="detail-section">
                    <h5><app-icon name="file" [size]="14"></app-icon> Receitas</h5>
                    <div class="document-list">
                      @for (rx of selectedEntry.prescriptions; track rx.id) {
                        <div class="document-item">
                          <div class="doc-info">
                            <span class="doc-date">{{ formatDate(rx.createdAt) }}</span>
                            @if (rx.isSigned) {
                              <span class="badge badge-success">Assinada</span>
                            }
                          </div>
                          <div class="doc-content">
                            @for (med of rx.medications; track med) {
                              <span class="medication">{{ med }}</span>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Exam Requests -->
                @if (selectedEntry.examRequests && selectedEntry.examRequests.length > 0) {
                  <div class="detail-section">
                    <h5><app-icon name="file-text" [size]="14"></app-icon> Exames Solicitados</h5>
                    <div class="document-list">
                      @for (exam of selectedEntry.examRequests; track exam.id) {
                        <div class="document-item">
                          <div class="doc-info">
                            <span class="doc-date">{{ formatDate(exam.dataEmissao) }}</span>
                            <span class="badge" [class.badge-warning]="exam.prioridade === 'Urgente'" [class.badge-secondary]="exam.prioridade !== 'Urgente'">
                              {{ exam.prioridade }}
                            </span>
                          </div>
                          <div class="doc-content">
                            <strong>{{ exam.nomeExame }}</strong>
                            <span class="category">({{ exam.categoria }})</span>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Medical Certificates -->
                @if (selectedEntry.medicalCertificates && selectedEntry.medicalCertificates.length > 0) {
                  <div class="detail-section">
                    <h5><app-icon name="file-text" [size]="14"></app-icon> Atestados</h5>
                    <div class="document-list">
                      @for (cert of selectedEntry.medicalCertificates; track cert.id) {
                        <div class="document-item">
                          <div class="doc-info">
                            <span class="doc-date">{{ formatDate(cert.dataEmissao) }}</span>
                            @if (cert.diasAfastamento) {
                              <span class="badge badge-info">{{ cert.diasAfastamento }} dias</span>
                            }
                          </div>
                          <div class="doc-content">
                            <strong>{{ cert.tipo }}</strong>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          }
        </div>
      }
      
      @if (timeline.entries.length === 0) {
        <div class="empty-state">
          <app-icon name="folder" [size]="48"></app-icon>
          <p>Nenhum histórico clínico encontrado para este paciente.</p>
        </div>
      }
    </div>
  }
</div>
