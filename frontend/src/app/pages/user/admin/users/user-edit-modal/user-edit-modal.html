@if (isOpen && user) {
  <div class="modal-backdrop" (click)="onBackdropClick()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <div class="modal__header-content">
          <app-icon name="user" [size]="24" />
          <h2 class="modal__title">Editar Usuário</h2>
        </div>
        <button
          type="button"
          class="modal__close"
          (click)="onCancel()"
          aria-label="Fechar"
        >
          <app-icon name="close" [size]="24" />
        </button>
      </div>

      <div class="modal__body">
        <div class="modal__avatar-section">
          <app-avatar 
            [name]="(editedUser.name || '') + ' ' + (editedUser.lastName || '')" 
            [imageUrl]="editedUser.avatar"
            size="xl"
          />
        </div>

        <form [formGroup]="userForm" class="user-form">
          <div class="user-form__row">
            <div class="user-form__field">
              <label for="user-name" class="user-form__label">Nome *</label>
              <input
                id="user-name"
                type="text"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('name')?.invalid && userForm.get('name')?.touched"
                formControlName="name"
                placeholder="Digite o nome"
              />
              @if (getErrorMessage('name')) {
                <span class="user-form__error">{{ getErrorMessage('name') }}</span>
              }
            </div>

            <div class="user-form__field">
              <label for="user-lastname" class="user-form__label">Sobrenome *</label>
              <input
                id="user-lastname"
                type="text"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched"
                formControlName="lastName"
                placeholder="Digite o sobrenome"
              />
              @if (getErrorMessage('lastName')) {
                <span class="user-form__error">{{ getErrorMessage('lastName') }}</span>
              }
            </div>
          </div>

          <div class="user-form__row">
            <div class="user-form__field">
              <label for="user-email" class="user-form__label">E-mail *</label>
              <input
                id="user-email"
                type="email"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
                formControlName="email"
                placeholder="Digite o e-mail"
              />
              @if (getErrorMessage('email')) {
                <span class="user-form__error">{{ getErrorMessage('email') }}</span>
              }
            </div>
          </div>

          <div class="user-form__row user-form__row--two-cols">
            <div class="user-form__field">
              <label for="user-cpf" class="user-form__label">CPF *</label>
              <input
                id="user-cpf"
                type="text"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('cpf')?.invalid && userForm.get('cpf')?.touched"
                formControlName="cpf"
                placeholder="000.000.000-00"
                appCpfMask
              />
              @if (getErrorMessage('cpf')) {
                <span class="user-form__error">{{ getErrorMessage('cpf') }}</span>
              }
            </div>

            <div class="user-form__field">
              <label for="user-phone" class="user-form__label">Telefone *</label>
              <input
                id="user-phone"
                type="tel"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('phone')?.invalid && userForm.get('phone')?.touched"
                formControlName="phone"
                placeholder="(00) 00000-0000"
                appPhoneMask
              />
              @if (getErrorMessage('phone')) {
                <span class="user-form__error">{{ getErrorMessage('phone') }}</span>
              }
            </div>
          </div>

          <div class="user-form__row user-form__row--two-cols">
            <div class="user-form__field">
              <label for="user-role" class="user-form__label">Perfil</label>
              <select
                id="user-role"
                class="user-form__select"
                formControlName="role"
              >
                <option value="PATIENT">Paciente</option>
                <option value="PROFESSIONAL">Profissional</option>
                <option value="ADMIN">Administrador</option>
              </select>
            </div>

            <div class="user-form__field">
              <label for="user-status" class="user-form__label">Status</label>
              <select
                id="user-status"
                class="user-form__select"
                formControlName="status"
              >
                <option value="Active">Ativo</option>
                <option value="Inactive">Inativo</option>
              </select>
            </div>
          </div>

          @if (userForm.get('role')?.value === 'PROFESSIONAL') {
            <div class="user-form__row">
              <div class="user-form__field">
                <label for="user-specialty" class="user-form__label">Especialidade</label>
                <select
                  id="user-specialty"
                  class="user-form__select"
                  formControlName="specialtyId"
                >
                  <option value="">Selecione uma especialidade</option>
                  @for (specialty of specialties; track specialty.id) {
                    <option [value]="specialty.id">{{ specialty.name }}</option>
                  }
                </select>
              </div>
            </div>
          }
        </form>
      </div>

      <div class="modal__footer">
        <app-button
          [variant]="'outline'"
          (click)="onCancel()"
        >
          Cancelar
        </app-button>
        <app-button
          [variant]="'primary'"
          (click)="onSave()"
          [disabled]="!isFormValid()"
        >
          Salvar Alterações
        </app-button>
      </div>
    </div>
  </div>
}
